

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Parallel processing with PyMS &mdash; PyMassSpec 2.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PyMassSpec
          

          
            
            <img src="../_static/pyms.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="chapter01.html">1. Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pyms/documentation.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Baseline/Baseline.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Baseline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Deconvolution/Deconvolution.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Deconvolution</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Display/Display.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Display</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Experiment/Experiment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Experiment</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Gapfill/Gapfill.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Gapfill</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/GCMS/GCMS.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.GCMS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Noise/Noise.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Noise</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Peak/Peak.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Peak</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Simulator/Simulator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Simulator</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms/Utils/Utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Utils</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing to PyMS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Contributing/Contributing.html">1. Contributing to PyMassSpec</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contributing/StyleGuide.html">2. PyMassSpec coding Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contributing/Source.html">3. Downloading PyMS source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contributing/Building.html">4. Building from Source</a></li>
</ul>
<p class="caption"><span class="caption-text">Tests and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/20a/20a.html">20a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/20b/20b.html">20b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/20c/20c.html">20c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/20d/20d.html">20d</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/30a/30a.html">30a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/30b/30b.html">30a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/30c/30c.html">30c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/31/31.html">31</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/32/32.html">32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/40a/40a.html">40a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/40b/40b.html">40b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/41a/41a.html">41a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/41b/41b.html">41b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/42a/42a.html">42a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/42b/42b.html">42b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/43/43.html">43</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/50/50.html">50</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/51/51.html">51</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/52/52.html">52</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/53/53.html">53</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/54/54.html">54</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/60/60.html">60</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/61a/61a.html">61a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/61b/61b.html">61b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/62/62.html">62</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/63/63.html">63</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/64/64.html">64</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/70a/70a.html">70a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/70b/70b.html">70b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/71/71.html">71</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/90/90.html">90</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/91/91.html">91</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/92/92.html">92</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/93/93.html">93</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/94/94.html">94</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/95/95.html">95</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/A1/A1.html">A1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/A2/A2.html">A2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyms-test/x10/x10.html">x10</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PyMassSpec</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Parallel processing with PyMS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/domdfcoding/pyms/docs/UserGuide/chapter09.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="parallel-processing-with-pyms">
<h1><a class="toc-backref" href="#id4">Parallel processing with PyMS</a><a class="headerlink" href="#parallel-processing-with-pyms" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#parallel-processing-with-pyms" id="id4">Parallel processing with PyMS</a></p>
<ul>
<li><p><a class="reference internal" href="#requirements" id="id5">Requirements</a></p></li>
<li><p><a class="reference internal" href="#background-to-using-pyms-in-parallel" id="id6">Background to using PyMS in parallel</a></p></li>
<li><p><a class="reference internal" href="#using-pyms-in-parallel" id="id7">Using PyMS in parallel</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id5">Requirements</a><a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The following markup has not been rewritten. Proceed with Caution</p>
</div>
<p>Using PyMS parallel capabilities requires installation of the package
‘mpi4py’, which provides bindings of the Message Passing Interface (MPI)
for the Python programming language. Installation instructions can be found in
<a class="reference external" href="chapter01.html#package-mpi4py-required-for-parallel-processing">here</a>.</p>
</div>
<div class="section" id="background-to-using-pyms-in-parallel">
<h2><a class="toc-backref" href="#id6">Background to using PyMS in parallel</a><a class="headerlink" href="#background-to-using-pyms-in-parallel" title="Permalink to this headline">¶</a></h2>
<p>Any processing that loops through ion chromatograms or mass spectra can
be performed in parallel, by distributing the processing of individual
ion chromatograms or mass spectra to different CPUs by using the
efficient MPI mechanism.</p>
<p>Before the parallel processing can be deployed, data needs to be binned
to produce an <a class="reference internal" href="../pyms/GCMS/GCMS.html#pyms.GCMS.Class.IntensityMatrix" title="pyms.GCMS.Class.IntensityMatrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">IntensityMatrix</span></code></a>
object, as described in the Section
“<a class="reference external" href="chapter04.html#intensitymatrix-object">IntensityMatrix Object</a>”.
This is essentially a two dimensional matrix, with ion chromatograms
along one dimension and mass spectra along the other dimension.</p>
<p>Consider the processing which applies a noise smoothing function to
each ion chromatogram. We first read the raw data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">andi_file</span> <span class="o">=</span> <span class="s2">&quot;data/gc01_0812_066.cdf&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ANDI_reader</span><span class="p">(</span><span class="n">andi_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Then build the intensity matrix, and get its dimensions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">im</span> <span class="o">=</span> <span class="n">build_intensity_matrix_i</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">n_scan</span><span class="p">,</span> <span class="n">n_mz</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span>
</pre></div>
</div>
<p>The last command sets the variables n_scan and n_mz to the number
scans and number of <span class="math notranslate nohighlight">\(m/z\)</span> values present in data, respectively.
Processing of ion chromatograms with the noise smoothing function
requires fetching of each ion chromatogram from the data, and
application of the noise smoothing function. This can be achieved
with a simple loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">n_mz</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_ic_at_index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="n">ic_smooth</span> <span class="o">=</span> <span class="n">window_smooth</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
<p>This example epitomizes the typical processing required on the
GC-MS data. Another, equally important processing, is that of
individual mass spectra. In this case the same logic can be
applied, except that one would loop over the other dimension
of the IntensityMatrix object ‘im’. That is, one would loop
over all the scan indices, and use the method
get_ms_at_index() to fetch individual mass spectra:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">n_scan</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_ms_at_index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="c1"># here do something the the mass spectra &#39;ms&#39;</span>
</pre></div>
</div>
<p>Processing of data in this fashion is computationally intensive.
A typical data set may consist of 3,000-10,000 scans and ~500
<span class="math notranslate nohighlight">\(m/z\)</span> values. If complex processing algorithms are applied to
each ion chromatogram (or mass spectra), the processing will
quickly become computationally prohibitive.</p>
<p>The type of calculation illustrated above is an ideal candidate
for parallelization because each ion chromatogram (or mass
spectrum) are processed independently. PyMS takes advantage
of this and allows one to harvest the power of multiple CPUs
to speed-up the processing. To achieve this PyMS can distributes
the loop from the above (either type, ie. over ion chromatograms
or mass spectra) over the available CPUs, achieving a linear
speed-up with the number of CPUs.</p>
</div>
<div class="section" id="using-pyms-in-parallel">
<h2><a class="toc-backref" href="#id7">Using PyMS in parallel</a><a class="headerlink" href="#using-pyms-in-parallel" title="Permalink to this headline">¶</a></h2>
<p>Using PyMS in parallel requires a minimal intervention, only
that special method of the IntensityMatrix object is invoked
in the for loop described above. For looping over all ion
chromatograms in parallel,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">im</span><span class="o">.</span><span class="n">iter_ic_indices</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_ic_at_index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="n">ic_smooth</span> <span class="o">=</span> <span class="n">window_smooth</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
<p>The only change is that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">n_mz</span><span class="p">:</span>
</pre></div>
</div>
<p>is replaced with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">im</span><span class="o">.</span><span class="n">iter_ic_indices</span><span class="p">()</span>
</pre></div>
</div>
<p>The corresponding method for looping over all mass spectra
would involve replacing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">n_scan</span><span class="p">:</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">im</span><span class="o">.</span><span class="n">iter_ms_indices</span><span class="p">()</span>
</pre></div>
</div>
<p>The special constructs <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">ii</span> <span class="pre">in</span> <span class="pre">im.iter_ic_indices():</span></code> and
<code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">ii</span> <span class="pre">in</span> <span class="pre">im.iter_ms_indices()</span></code> will distribute the calculation
in parallel if MPI capability is available (ie. mpi4py is installed
on the system, and multiple CPUs are available). If MPI capability
is not available, the processing will be performed in a serial mode.
Running in parallel also requires some prior preparations, as explained
below.</p>
<p>Consider how the following script that performs noise smoothing example
described above (named ‘proc.py’). This script is can be run in serial
or parallel mode.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="sd">&quot;&quot;&quot;proc.py</span>
<span class="sd"> &quot;&quot;&quot;</span>

 <span class="kn">import</span> <span class="nn">sys</span>
 <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/x/PyMS&quot;</span><span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pyms.GCMS.IO.ANDI.Function</span> <span class="kn">import</span> <span class="n">ANDI_reader</span>
 <span class="kn">from</span> <span class="nn">pyms.GCMS.Function</span> <span class="kn">import</span> <span class="n">build_intensity_matrix_i</span>
 <span class="kn">from</span> <span class="nn">pyms.Noise.Window</span> <span class="kn">import</span> <span class="n">window_smooth</span>

 <span class="c1"># read the raw data as a GCMS_data object</span>
 <span class="n">andi_file</span> <span class="o">=</span> <span class="s2">&quot;data/gc01_0812_066.cdf&quot;</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">ANDI_reader</span><span class="p">(</span><span class="n">andi_file</span><span class="p">)</span>

 <span class="c1"># build the intensity matrix</span>
 <span class="n">im</span> <span class="o">=</span> <span class="n">build_intensity_matrix_i</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

 <span class="c1"># get the size of the intensity matrix</span>
 <span class="n">n_scan</span><span class="p">,</span> <span class="n">n_mz</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span>
 <span class="k">print</span> <span class="s2">&quot;Size of the intensity matrix is (n_scans, n_mz):&quot;</span><span class="p">,</span> <span class="n">n_scan</span><span class="p">,</span> <span class="n">n_mz</span>

 <span class="c1"># loop over all m/z values, fetch the corresponding IC, and perform</span>
 <span class="c1"># noise smoothing</span>
 <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">im</span><span class="o">.</span><span class="n">iter_ic_indices</span><span class="p">():</span>
     <span class="k">print</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
     <span class="n">ic</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_ic_at_index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
     <span class="n">ic_smooth</span> <span class="o">=</span> <span class="n">window_smooth</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>A simple running of this script will produce a serial run without any warning messages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python3 proc.py
 -&gt; Reading netCDF file <span class="s1">&#39;data/gc01_0812_066.cdf&#39;</span>
Size of the intensity matrix is <span class="o">(</span>n_scans, n_mz<span class="o">)</span>: <span class="m">9865</span> <span class="m">551</span>
<span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span>
<span class="m">26</span> <span class="m">27</span> <span class="m">28</span> <span class="m">29</span> <span class="m">30</span> <span class="m">31</span> <span class="m">32</span> <span class="m">33</span> <span class="m">34</span> <span class="m">35</span> <span class="m">36</span> <span class="m">37</span> <span class="m">38</span> <span class="m">39</span> <span class="m">40</span> <span class="m">41</span> <span class="m">42</span> <span class="m">43</span> <span class="m">44</span> <span class="m">45</span> <span class="m">46</span> <span class="m">47</span>
... <span class="o">[</span> further output deleted <span class="o">]</span> ...
</pre></div>
</div>
<p>Inspection of the CPU usage during the execution of the program
shows that only one CPU is utilised 100% (although multiple CPUs
are available) as shown here:</p>
<div class="figure align-center" id="id1">
<img alt="The xterm output of the program 'top' with PyMS running in serial mode on the computer with multiple CPUs" src="../_images/top-serial.png" />
<p class="caption"><span class="caption-text">The xterm output of the program ‘top’ with PyMS running in serial mode on the computer with multiple CPUs</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>To run the above script in parallel, one needs first to start the
mpich process launcher, called ‘mpd’ (this is a program, in this
example located in <code class="docutils literal notranslate"><span class="pre">/usr/bin/mpd</span></code>) This can be achieved as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ /usr/bin/mpd --daemon
</pre></div>
</div>
<p>The above command starts ‘mpd’ as a daemon (the program runs in the
background, without a controlling terminal).  A common problem that
causes the above command is fail is the absence of the file <code class="docutils literal notranslate"><span class="pre">.mpd.conf</span></code>
which ‘mpd’ requires to be present in the home directory of the user
who is starting the process. Here is an excerpt from the ‘mpd’ help page:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>A file named .mpd.conf file must be present in the user&#39;s home directory
with read and write access only for the user, and must contain at least
a line with MPD_SECRETWORD=&lt;secretword&gt;
To run mpd as root, install it while root and instead of a .mpd.conf file
use mpd.conf (no leading dot) in the /etc directory.&#39;
</pre></div>
</div>
<p>Fixing this problem is simple, and requires creating the file
<code class="docutils literal notranslate"><span class="pre">~/.mpd.conf</span></code>, which in our case contains only one line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">MPD_SECRETWORD</span><span class="o">=</span>euSe0veo
</pre></div>
</div>
<p>After this the ‘mpd’ can be launched. Running the PyMS script in the parallel
mode requires the use of ‘mpirun’ command,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ /usr/bin/mpirun -np <span class="m">2</span> python proc.py
</pre></div>
</div>
<p>The above command prepare ‘python proc.py’ to run in parallel, in this
case by using two CPUS (<code class="docutils literal notranslate"><span class="pre">-np</span> <span class="pre">2</span></code>). The execution produces the following output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ /usr/bin/mpirun -np <span class="m">2</span> python proc.py
 -&gt; Reading netCDF file <span class="s1">&#39;data/gc01_0812_066.cdf&#39;</span>
 -&gt; Reading netCDF file <span class="s1">&#39;data/gc01_0812_066.cdf&#39;</span>
Size of the intensity matrix is <span class="o">(</span>n_scans, n_mz<span class="o">)</span>:Size of
the intensity matrix is <span class="o">(</span>n_scans, n_mz<span class="o">)</span>: <span class="m">9865</span> <span class="m">551</span>
<span class="m">276</span> <span class="m">9865</span> <span class="m">551</span>
<span class="m">1</span> <span class="m">277</span> <span class="m">2</span> <span class="m">278</span> <span class="m">3</span> <span class="m">279</span> <span class="m">4</span> <span class="m">280</span> <span class="m">5</span> <span class="m">281</span> <span class="m">6</span> <span class="m">282</span> <span class="m">7</span> <span class="m">283</span> <span class="m">8</span> <span class="m">284</span> <span class="m">9</span> <span class="m">285</span> <span class="m">10</span> <span class="m">286</span> <span class="m">11</span> <span class="m">287</span> <span class="m">12</span>
<span class="m">288</span> <span class="m">13</span> <span class="m">289</span> <span class="m">14</span> <span class="m">290</span> <span class="m">15</span> <span class="m">291</span> <span class="m">16</span> <span class="m">292</span> <span class="m">17</span> <span class="m">293</span> <span class="m">18</span> <span class="m">294</span> <span class="m">19</span> <span class="m">295</span> <span class="m">20</span> <span class="m">296</span> <span class="m">21</span> <span class="m">297</span> <span class="m">22</span>
<span class="m">298</span> <span class="m">23</span> <span class="m">299</span> <span class="m">24</span> <span class="m">300</span> <span class="m">25</span> <span class="m">301</span> <span class="m">26</span> <span class="m">302</span> <span class="m">27</span> <span class="m">303</span> <span class="m">28</span> <span class="m">304</span> <span class="m">2</span>
... <span class="o">[</span> further output deleted <span class="o">]</span> ...
</pre></div>
</div>
<p>The above shows that two processes are active (each reading its own
version of data). While the distribution of processing between the
two processes has been achieved automatically by PyMS. Since both
processes were started from the same terminal their output is
intermingled. This time the processing is using two CPUs, and this
can be seen from the inspection of CPU utilisation, as shown below.
Also the execution of the script ‘proc.py’ is now two times faster.</p>
<div class="figure align-center" id="id2">
<img alt="The xterm output of the program 'top' with PyMS running in parallel mode with two CPUs" src="../_images/top-parallel.png" />
<p class="caption"><span class="caption-text">The xterm output of the program ‘top’ with PyMS running in parallel mode with two CPUs</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>This simple example shows how to speed-up PyMS processing on a common
workstation with two CPUs. The MPI also allows PyMS processing to run
on specialised computers with many CPUs, such as Linux clusters. The
MPI implementation allows PyMS to be easily used in such distributed
computing environments, much like in the example above. We have tested
PyMS on Linux clusters, and the resulting speed-up is nearly linear
with the number of CPUs employed.</p>
<div class="figure align-center" id="id3">
<img alt="The speedup in PyMS processing when run in parallel on a Linux cluster as a function of a number of CPUs deployed" src="../_images/speedup-parallel.png" />
<p class="caption"><span class="caption-text">The speedup in PyMS processing when run in parallel on a Linux cluster as a function of a number of CPUs deployed</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright PyMassSpec Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>