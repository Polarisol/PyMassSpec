

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyms.Peak.List.DPA.Class &mdash; PyMassSpec 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> PyMassSpec
          

          
            
            <img src="../../../../../_static/pyms.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../UserGuide/chapter01.html">1. Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/documentation.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Baseline/Baseline.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Baseline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Deconvolution/Deconvolution.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Deconvolution</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Display/Display.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Display</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Experiment/Experiment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Experiment</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Gapfill/Gapfill.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Gapfill</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/GCMS/GCMS.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.GCMS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Noise/Noise.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Noise</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Peak/Peak.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Peak</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Simulator/Simulator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Simulator</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms/Utils/Utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyms.Utils</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing to PyMS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../UserGuide/Contributing/Contributing.html">1. Contributing to PyMassSpec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../UserGuide/Contributing/StyleGuide.html">2. PyMassSpec coding Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../UserGuide/Contributing/Source.html">3. Downloading PyMS source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../UserGuide/Contributing/Building.html">4. Building from Source</a></li>
</ul>
<p class="caption"><span class="caption-text">Tests and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/20a/20a.html">20a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/20b/20b.html">20b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/20c/20c.html">20c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/20d/20d.html">20d</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/30a/30a.html">30a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/30b/30b.html">30a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/30c/30c.html">30c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/31/31.html">31</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/32/32.html">32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/40a/40a.html">40a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/40b/40b.html">40b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/41a/41a.html">41a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/41b/41b.html">41b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/42a/42a.html">42a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/42b/42b.html">42b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/43/43.html">43</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/50/50.html">50</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/51/51.html">51</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/52/52.html">52</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/53/53.html">53</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/54/54.html">54</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/60/60.html">60</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/61a/61a.html">61a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/61b/61b.html">61b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/62/62.html">62</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/63/63.html">63</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/64/64.html">64</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/70a/70a.html">70a</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/70b/70b.html">70b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/71/71.html">71</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/90/90.html">90</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/91/91.html">91</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/92/92.html">92</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/93/93.html">93</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/94/94.html">94</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/95/95.html">95</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/A1/A1.html">A1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/A2/A2.html">A2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyms-test/x10/x10.html">x10</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">PyMassSpec</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>pyms.Peak.List.DPA.Class</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyms.Peak.List.DPA.Class</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes for peak alignment by dynamic programming</span>
<span class="sd">&quot;&quot;&quot;</span>

 <span class="c1">#############################################################################</span>
 <span class="c1">#                                                                           #</span>
 <span class="c1">#    PyMS software for processing of metabolomic mass-spectrometry data     #</span>
 <span class="c1">#    Copyright (C) 2005-2012 Vladimir Likic                                 #</span>
 <span class="c1">#                                                                           #</span>
 <span class="c1">#    This program is free software; you can redistribute it and/or modify   #</span>
 <span class="c1">#    it under the terms of the GNU General Public License version 2 as      #</span>
 <span class="c1">#    published by the Free Software Foundation.                             #</span>
 <span class="c1">#                                                                           #</span>
 <span class="c1">#    This program is distributed in the hope that it will be useful,        #</span>
 <span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of         #</span>
 <span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the          #</span>
 <span class="c1">#    GNU General Public License for more details.                           #</span>
 <span class="c1">#                                                                           #</span>
 <span class="c1">#    You should have received a copy of the GNU General Public License      #</span>
 <span class="c1">#    along with this program; if not, write to the Free Software            #</span>
 <span class="c1">#    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.              #</span>
 <span class="c1">#                                                                           #</span>
 <span class="c1">#############################################################################</span>

<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Pycluster</span> <span class="k">import</span> <span class="n">treecluster</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Bio.Cluster</span> <span class="k">import</span> <span class="n">treecluster</span>

<span class="kn">from</span> <span class="nn">pyms.Utils.Error</span> <span class="k">import</span> <span class="n">error</span><span class="p">,</span> <span class="n">stop</span>
<span class="kn">from</span> <span class="nn">pyms.Utils.IO</span> <span class="k">import</span> <span class="n">dump_object</span>
<span class="kn">from</span> <span class="nn">pyms.Experiment.Class</span> <span class="k">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">pyms.GCMS.Class</span> <span class="k">import</span> <span class="n">MassSpectrum</span>
<span class="kn">from</span> <span class="nn">pyms.Peak.Class</span> <span class="k">import</span> <span class="n">Peak</span>
<span class="kn">from</span> <span class="nn">pyms.Peak.List.Function</span> <span class="k">import</span> <span class="n">composite_peak</span>

<span class="kn">from</span> <span class="nn">pyms.Peak.List.DPA</span> <span class="k">import</span> <span class="n">Function</span>

<span class="c1"># If psyco is installed, use it to speed up running time</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">psyco</span>
    <span class="n">psyco</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="Alignment"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment">[docs]</a><span class="k">class</span> <span class="nc">Alignment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :summary: Models an alignment of peak lists</span>

<span class="sd">    :author: Woon Wai Keen</span>
<span class="sd">    :author: Vladimir Likic</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Alignment.__init__"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param expr: The experiment to be converted into an alignment object</span>
<span class="sd">        :type expr: pyms.Experiment.Class.Experiment</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Qiao Wang</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expr_code</span> <span class="o">=</span>  <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Experiment</span><span class="p">):</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;expr&#39; must be an Experiment object&quot;</span><span class="p">)</span>
            <span class="c1">#for peak in expr.get_peak_list():</span>
            <span class="c1">#    if peak.get_area() == None or peak.get_area() &lt;= 0:</span>
            <span class="c1">#        error(&quot;All peaks must have an area for alignment&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span> <span class="o">=</span> <span class="p">[</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">get_peak_list</span><span class="p">())</span> <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expr_code</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">expr</span><span class="o">.</span><span class="n">get_expr_code</span><span class="p">()</span> <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Alignment.__len__"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.__len__">[docs]</a>    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Returns the length of the alignment, defined as the number of</span>
<span class="sd">            peak positions in the alignment</span>

<span class="sd">        :author: Qiao Wang</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Alignment.filter_min_peaks"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.filter_min_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">filter_min_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_peaks</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Filters alignment positions that have less peaks than &#39;min_peaks&#39;</span>

<span class="sd">            </span>
<span class="sd">            This function is useful only for within state alignment.</span>

<span class="sd">        :param min_peaks: Minimum number of peaks required for the alignment</span>
<span class="sd">            position to survive filtering</span>
<span class="sd">        :type min_peaks: IntType</span>

<span class="sd">        :author: Qiao Wang</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filtered_list</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span><span class="p">)):</span>
            <span class="c1">#if len(filter(None,self.peakalgt[pos])) &gt;= min_peaks:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_peaks</span><span class="p">:</span>
                <span class="n">filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span> <span class="o">=</span> <span class="n">filtered_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakalgt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Alignment.write_csv"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.write_csv">[docs]</a>    <span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt_file_name</span><span class="p">,</span> <span class="n">area_file_name</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Writes the alignment to CSV files</span>

<span class="sd">        This function writes two files: one containing the alignment of peak</span>
<span class="sd">        retention times and the other containing the alignment of peak areas.</span>

<span class="sd">        :param rt_file_name: The name for the retention time alignment file</span>
<span class="sd">        :type rt_file_name: StringType</span>
<span class="sd">        :param area_file_name: The name for the areas alignment file</span>
<span class="sd">        :type area_file_name: StringType</span>
<span class="sd">        :param minutes: An optional indicator whether to save retention times</span>
<span class="sd">            in minutes. If False, retention time will be saved in seconds</span>
<span class="sd">        :type minutes: BooleanType</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Andrew Isaac</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rt_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">fp2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">area_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open output file for writing&quot;</span><span class="p">)</span>

        <span class="c1"># create header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&quot;UID&quot;,&quot;RTavg&quot;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr_code</span><span class="p">:</span>
            <span class="n">expr_code</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">item</span> <span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">expr_code</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># write headers</span>
        <span class="n">fp1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">fp2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># for each alignment position write alignment&#39;s peak and area</span>
        <span class="k">for</span> <span class="n">peak_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>

            <span class="n">rts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">areas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_peak_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">avgrt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">countrt</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">align_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">)):</span>

                <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">[</span><span class="n">align_idx</span><span class="p">][</span><span class="n">peak_idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">minutes</span><span class="p">:</span>
                        <span class="n">rt</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_rt</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rt</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_rt</span><span class="p">()</span>

                    <span class="n">rts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
                    <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">get_area</span><span class="p">())</span>
                    <span class="n">new_peak_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

                    <span class="n">avgrt</span> <span class="o">=</span> <span class="n">avgrt</span> <span class="o">+</span> <span class="n">rt</span>
                    <span class="n">countrt</span> <span class="o">=</span> <span class="n">countrt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">countrt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avgrt</span> <span class="o">=</span> <span class="n">avgrt</span><span class="o">/</span><span class="n">countrt</span>

            <span class="n">compo_peak</span> <span class="o">=</span> <span class="n">composite_peak</span><span class="p">(</span><span class="n">new_peak_list</span><span class="p">,</span> <span class="n">minutes</span><span class="p">)</span>
            <span class="n">peak_UID</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_UID</span><span class="p">()</span>
            <span class="n">peak_UID_string</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">peak_UID</span><span class="p">)</span>

            <span class="c1"># write to retention times file</span>
            <span class="n">fp1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">peak_UID_string</span><span class="p">)</span>
            <span class="n">fp1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">avgrt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">rts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rt</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fp1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,NA&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fp1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rt</span><span class="p">)</span>
            <span class="n">fp1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># write to peak areas file</span>
            <span class="n">fp2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">peak_UID_string</span><span class="p">)</span>
            <span class="n">fp2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">avgrt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">areas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fp2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,NA&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fp2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">area</span><span class="p">)</span>
            <span class="n">fp2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fp1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fp2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Alignment.write_common_ion_csv"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.write_common_ion_csv">[docs]</a>    <span class="k">def</span> <span class="nf">write_common_ion_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">area_file_name</span><span class="p">,</span> <span class="n">top_ion_list</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Writes the alignment to CSV files</span>

<span class="sd">        This function writes two files: one containing the alignment of peak</span>
<span class="sd">        retention times and the other containing the alignment of peak areas.</span>

<span class="sd">        :param area_file_name: The name for the areas alignment file</span>
<span class="sd">        :type area_file_name: StringType</span>
<span class="sd">        :param top_ion_list: A list of the highest intensity common ion</span>
<span class="sd">                             along the aligned peaks</span>
<span class="sd">        :type top_ion_list: ListType</span>
<span class="sd">        :param minutes: An optional indicator whether to save retention times</span>
<span class="sd">            in minutes. If False, retention time will be saved in seconds</span>
<span class="sd">        :type minutes: BooleanType</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Andrew Isaac</span>
<span class="sd">        :author: Sean O&#39;Callaghan</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">area_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open output file for writing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">top_ion_list</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;List of common ions must be supplied&quot;</span><span class="p">)</span>

        <span class="c1"># create header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&quot;UID&quot;,&quot;RTavg&quot;, &quot;Quant Ion&quot;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr_code</span><span class="p">:</span>
            <span class="n">expr_code</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">item</span> <span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">expr_code</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># write headers</span>

        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="n">rtsums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtcounts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># The following two arrays will become list of lists</span>
        <span class="c1"># such that:</span>
        <span class="c1"># areas = [  [align1_peak1, align2_peak1, .....,alignn_peak1]</span>
        <span class="c1">#            [align1_peak2, ................................]</span>
        <span class="c1">#              .............................................</span>
        <span class="c1">#            [align1_peakm,....................,alignn_peakm]  ]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_peak_lists</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">peak_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peak_list</span><span class="p">:</span>
                <span class="c1"># one the first iteration, populate the lists</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_list</span><span class="p">):</span>
                    <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">new_peak_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">rtsums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">rtcounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rt</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_rt</span><span class="p">()</span>

                    <span class="c1"># get the area of the common ion for the peak</span>
                    <span class="c1"># an area of &#39;na&#39; shows that while the peak was</span>
                    <span class="c1"># aligned, the common ion was not present</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_ion_area</span><span class="p">(</span><span class="n">top_ion_list</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                     
                    <span class="n">areas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
                    <span class="n">new_peak_lists</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

                    <span class="c1"># The following code to the else statement is</span>
                    <span class="c1"># just for calculating the average rt</span>
                    <span class="n">rtsums</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rt</span>
                    <span class="n">rtcounts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">areas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">out_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># now write the strings for the file</span>
        <span class="k">for</span> <span class="n">area_list</span> <span class="ow">in</span> <span class="n">areas</span><span class="p">:</span>
 
            <span class="c1"># write initial info:</span>
            <span class="c1"># peak unique id, peak average rt</span>
            <span class="n">compo_peak</span> <span class="o">=</span> <span class="n">composite_peak</span><span class="p">(</span><span class="n">new_peak_lists</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">minutes</span><span class="p">)</span>
            <span class="n">peak_UID</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_UID</span><span class="p">()</span>
            <span class="n">peak_UID_string</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">peak_UID</span><span class="p">)</span>

            <span class="n">rt_avg</span> <span class="o">=</span> <span class="n">rtsums</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">/</span><span class="n">rtcounts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    
            <span class="n">out_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_UID_string</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rt_avg</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span><span class="o">+</span>\
                                   <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">top_ion_list</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">area_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">out_strings</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">area</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_strings</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;,NA&quot;</span><span class="p">)</span>
            
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># now write the file</span>
<span class="c1">#        print(&quot;length of areas[0]&quot;, len(areas[0]))</span>
<span class="c1">#        print(&quot;lenght of areas&quot;, len(areas))</span>
<span class="c1">#        print(&quot;length of out_strings&quot;, len(out_strings))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">out_strings</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Alignment.common_ion"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.common_ion">[docs]</a>    <span class="k">def</span> <span class="nf">common_ion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Calculates a common ion among the</span>
<span class="sd">                  peaks of an aligned peak</span>

<span class="sd">        :return: A list of the highest intensity common ion for all aligned</span>
<span class="sd">                 peaks</span>
<span class="sd">        :rtype: ListType</span>

<span class="sd">        :author: Sean O&#39;Callaghan</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(&quot;#peak lists =&quot;, len(self.peakpos))</span>
        <span class="c1"># print(&quot;#peaks =&quot;, len(self.peakpos[0]))</span>
        
        <span class="c1"># a list to contain the dictionaries</span>
        <span class="c1"># each dictionary contains the</span>
        <span class="c1"># top ions and their frequency for each peak</span>
        <span class="c1"># in the alignment</span>
        <span class="n">list_of_top_ion_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">empty_count_list</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">peak_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">:</span>
            <span class="c1"># (re)initialise the peak index</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peak_list</span><span class="p">:</span>
                <span class="c1"># if the dict has not been created, create it</span>
                <span class="c1"># will only run on first peak list</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_top_ion_dicts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_list</span><span class="p">):</span>
                    <span class="n">list_of_top_ion_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                    
                <span class="c1"># copy the list entry to a local dict for code clarity</span>
                <span class="n">top_ion_dict</span> <span class="o">=</span> <span class="n">list_of_top_ion_dicts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                <span class="c1"># count the empty peaks</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">empty_count_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_list</span><span class="p">):</span>
                    <span class="n">empty_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">empty_count</span> <span class="o">=</span> <span class="n">empty_count_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> 
                <span class="c1">#make sure the peak is present</span>
                <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># get the top 5 ions</span>
                    <span class="n">top_5</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_ion_areas</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                
                    <span class="k">for</span> <span class="n">ion</span> <span class="ow">in</span> <span class="n">top_5</span><span class="p">:</span>
                        <span class="c1"># if we haven&#39;t seen it before, add it</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">top_ion_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">ion</span><span class="p">):</span>
                            <span class="n">top_ion_dict</span><span class="p">[</span><span class="n">ion</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                        <span class="c1"># if we have seen it, increment the count</span>
                        <span class="k">elif</span> <span class="n">top_ion_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">ion</span><span class="p">):</span>
                            <span class="n">top_ion_dict</span><span class="p">[</span><span class="n">ion</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="c1"># shouldn&#39;t happen</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error: in function common_ion()&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">empty_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># copy the dict back to the list</span>
                    <span class="n">list_of_top_ion_dicts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_ion_dict</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_count_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_list</span><span class="p">):</span>
                        <span class="n">empty_count_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_count</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">empty_count_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_count</span>
                <span class="c1"># increment for the next peak</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1">#print(&quot;length of list of dicts&quot;, len(list_of_top_ion_dicts))</span>

        <span class="c1">#index = 0</span>
        <span class="c1">#for entry in list_of_top_ion_dicts:</span>
        <span class="c1">#    for ion in sorted(entry, key=entry.get, reverse=True)[0:3]:</span>
        <span class="c1">#        print(ion,&quot;:&quot;, entry[ion],end=&#39;&#39;)</span>
        <span class="c1">#    print(&#39;  empty:&#39;, empty_count_list[index])</span>
        <span class="c1">#    index += 1</span>

        <span class="n">top_ion_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">list_of_top_ion_dicts</span><span class="p">:</span>
            <span class="n">top_ion_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_highest_mz_ion</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">top_ion_list</span></div>

<div class="viewcode-block" id="Alignment.get_highest_mz_ion"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.get_highest_mz_ion">[docs]</a>    <span class="k">def</span> <span class="nf">get_highest_mz_ion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ion_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Returns the preferred ion for quantitiation</span>
<span class="sd">                  Looks at the list of candidate ions, selects those</span>
<span class="sd">                  which have highest occurance, and selects the heaviest</span>
<span class="sd">                  of those</span>

<span class="sd">        :param ion_dict: a dictionary of mz value: number of occurances</span>
<span class="sd">        :type ion_dict: dictType</span>

<span class="sd">        :return ion: The ion to use</span>
<span class="sd">        :rtype: intType</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">max_occurances</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ion_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="n">most_freq_mzs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ion_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">max_occurances</span><span class="p">:</span>
                <span class="n">most_freq_mzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">most_freq_mzs</span><span class="p">)</span></div>
        


<div class="viewcode-block" id="Alignment.write_mass_hunter_csv"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.write_mass_hunter_csv">[docs]</a>    <span class="k">def</span> <span class="nf">write_mass_hunter_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">top_ion_list</span><span class="p">):</span><span class="c1">#, peak_list_name):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Returns a csv file with ion ratios</span>
<span class="sd">                  and UID</span>

<span class="sd">        :param out_file: name of the output file</span>
<span class="sd">        :type out_file: strType</span>

<span class="sd">        :param top_ion_list: a list of the common ions for each</span>
<span class="sd">                             peak in the averaged peak list for the</span>
<span class="sd">                             alignment</span>
<span class="sd">        :type top_ion_list: listType</span>

<span class="sd">        :return: a csv file with UID, common and qualifying ions</span>
<span class="sd">                 and their ratios for mass hunter interpretation</span>
<span class="sd">        :rtype: fileType</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open output file for writing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">top_ion_list</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;List of common ions must be supplied&quot;</span><span class="p">)</span>

        <span class="c1"># create header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&quot;UID&quot;,&quot;Common Ion&quot;, &quot;Qual Ion 1&quot;, &quot;ratio QI1/CI&quot;, &quot;Qual Ion 2&quot;, &quot;ratio QI2/CI&quot;, &quot;l window delta&quot;, &quot;r window delta&quot;&#39;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># write headers</span>

        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="n">rtsums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtcounts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># The following two arrays will become list of lists</span>
        <span class="c1"># such that:</span>
        <span class="c1"># areas = [  [align1_peak1, align2_peak1, .....,alignn_peak1]</span>
        <span class="c1">#            [align1_peak2, ................................]</span>
        <span class="c1">#              .............................................</span>
        <span class="c1">#            [align1_peakm,....................,alignn_peakm]  ]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_peak_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtmax</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtmin</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">peak_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peak_list</span><span class="p">:</span>
                <span class="c1"># on the first iteration, populate the lists</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_list</span><span class="p">):</span>
                    <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">new_peak_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">rtsums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">rtcounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">rtmax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">rtmin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    

                <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rt</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_rt</span><span class="p">()</span>
                    

                    <span class="c1"># get the area of the common ion for the peak</span>
                    <span class="c1"># an area of &#39;na&#39; shows that while the peak was</span>
                    <span class="c1"># aligned, the common ion was not present</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">get_ion_area</span><span class="p">(</span><span class="n">top_ion_list</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                     
                    <span class="n">areas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
                    <span class="n">new_peak_lists</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

                    <span class="c1"># The following code to the else statement is</span>
                    <span class="c1"># just for calculating the average rt</span>
                    <span class="n">rtsums</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rt</span>
                    <span class="n">rtcounts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># quick workaround for weird problem when</span>
                    <span class="c1"># attempting to set rtmin to max time above</span>
                    <span class="k">if</span> <span class="n">rtmin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">rtmin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5400.0</span>
                        
                    <span class="k">if</span> <span class="n">rt</span> <span class="o">&gt;</span> <span class="n">rtmax</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                        <span class="n">rtmax</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt</span>
                        
                    <span class="k">if</span> <span class="n">rt</span> <span class="o">&lt;</span> <span class="n">rtmin</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                        <span class="n">rtmin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">areas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">out_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">compo_peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># now write the strings for the file</span>
        <span class="k">for</span> <span class="n">area_list</span> <span class="ow">in</span> <span class="n">areas</span><span class="p">:</span>
 
            <span class="c1"># write initial info:</span>
            <span class="c1"># peak unique id, peak average rt</span>
            <span class="n">compo_peak</span> <span class="o">=</span> <span class="n">composite_peak</span><span class="p">(</span><span class="n">new_peak_lists</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">minutes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">compo_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compo_peak</span><span class="p">)</span>
            <span class="n">peak_UID</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_UID</span><span class="p">()</span>
            <span class="n">peak_UID_string</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">peak_UID</span><span class="p">)</span>

            <span class="c1">#calculate the time from the leftmost peak to the average</span>
            <span class="n">l_window_delta</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_rt</span><span class="p">()</span> <span class="o">-</span> <span class="n">rtmin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c1">#print(&quot;l_window&quot;, l_window_delta, &quot;rt&quot;, compo_peak.get_rt(), &quot;rt_min&quot;, rtmin[index])</span>
            <span class="n">r_window_delta</span> <span class="o">=</span> <span class="n">rtmax</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_rt</span><span class="p">()</span>

            <span class="n">common_ion</span> <span class="o">=</span> <span class="n">top_ion_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">qual_ion_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak_UID_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
            <span class="n">qual_ion_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak_UID_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">qual_ion_1</span> <span class="o">==</span> <span class="n">common_ion</span><span class="p">:</span>
                <span class="n">qual_ion_1</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_third_highest_mz</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">qual_ion_2</span> <span class="o">==</span> <span class="n">common_ion</span><span class="p">:</span>
                <span class="n">qual_ion_2</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_third_highest_mz</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            
            <span class="n">ci_intensity</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_int_of_ion</span><span class="p">(</span><span class="n">common_ion</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ci_intensity</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Ci for peak&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">q1_intensity</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_int_of_ion</span><span class="p">(</span><span class="n">qual_ion_1</span><span class="p">)</span>
            <span class="n">q2_intensity</span> <span class="o">=</span> <span class="n">compo_peak</span><span class="o">.</span><span class="n">get_int_of_ion</span><span class="p">(</span><span class="n">qual_ion_2</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">q1_ci_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">q1_intensity</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ci_intensity</span><span class="p">)</span>
            <span class="k">except</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span> <span class="c1"># if no area available for that ion</span>
                <span class="n">q1_ci_ratio</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">except</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">):</span> <span class="c1">#shouldn&#39;t happen but does!!</span>
                <span class="n">q1_ci_ratio</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">q2_ci_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">q2_intensity</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ci_intensity</span><span class="p">)</span>
            <span class="k">except</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">q2_ci_ratio</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">except</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">):</span> <span class="c1">#shouldn&#39;t happen, but does!!</span>
                <span class="n">q2_ci_ratio</span> <span class="o">=</span> <span class="mf">0.01</span>
                                


            <span class="n">out_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_UID</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">common_ion</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> \
                                   <span class="nb">str</span><span class="p">(</span><span class="n">qual_ion_1</span><span class="p">)</span> <span class="o">+</span> \
                                   <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q1_ci_ratio</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>\
                                   <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">qual_ion_2</span><span class="p">)</span> <span class="o">+</span> \
                                   <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q2_ci_ratio</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span>
                               <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">l_window_delta</span><span class="o">+</span><span class="mf">1.5</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span> <span class="o">+</span>
                               <span class="p">(</span><span class="s2">&quot;,</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">r_window_delta</span><span class="o">+</span><span class="mf">1.5</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)))</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># now write the file</span>
<span class="c1">#        print(&quot;length of areas[0]&quot;, len(areas[0]))</span>
<span class="c1">#        print(&quot;lenght of areas&quot;, len(areas))</span>
<span class="c1">#        print(&quot;length of out_strings&quot;, len(out_strings))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">out_strings</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#dump_object(compo_peaks, peak_list_name)</span>
                
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        

<div class="viewcode-block" id="Alignment.aligned_peaks"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.Alignment.aligned_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">aligned_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Returns a list of Peak objects where each peak</span>
<span class="sd">            has the combined spectra and average retention time</span>
<span class="sd">            of all peaks that aligned.</span>

<span class="sd">        :param minutes: An optional indicator of whether retention</span>
<span class="sd">            times are in minutes. If False, retention time are in</span>
<span class="sd">            seconds</span>
<span class="sd">        :type minutes: BooleanType</span>

<span class="sd">        :return: A list of composite peaks based on the alignment.</span>
<span class="sd">        :rtype: ListType</span>

<span class="sd">        :author: Andrew Isaac</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># for all peaks found</span>
        <span class="n">peak_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">peak_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="c1"># get aligned peaks, ignore missing</span>
            <span class="n">new_peak_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">align_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">)):</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakpos</span><span class="p">[</span><span class="n">align_idx</span><span class="p">][</span><span class="n">peak_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_peak_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
            <span class="c1">#create composite</span>
            <span class="n">new_peak</span> <span class="o">=</span> <span class="n">composite_peak</span><span class="p">(</span><span class="n">new_peak_list</span><span class="p">,</span> <span class="n">minutes</span><span class="p">)</span>
            <span class="n">peak_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_peak</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">peak_list</span></div></div>

<div class="viewcode-block" id="PairwiseAlignment"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.PairwiseAlignment">[docs]</a><span class="k">class</span> <span class="nc">PairwiseAlignment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :summary: Models pairwise alignment of alignments</span>

<span class="sd">    :author: Woon Wai Keen</span>
<span class="sd">    :author: Vladimir Likic</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PairwiseAlignment.__init__"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.PairwiseAlignment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algts</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">gap</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param algts: A list of alignments</span>
<span class="sd">        :type algts: ListType</span>
<span class="sd">        :param D: Retention time tolerance parameter for pairwise alignments</span>
<span class="sd">        :type D: FloatType</span>
<span class="sd">        :param gap: Gap parameter for pairwise alignments</span>
<span class="sd">        :type gap: FloatType</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algts</span> <span class="o">=</span> <span class="n">algts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">gap</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_matrix</span><span class="p">(</span><span class="n">algts</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">gap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_matrix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guide_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_matrix</span><span class="p">)</span></div>

<div class="viewcode-block" id="PairwiseAlignment._sim_matrix"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.PairwiseAlignment._sim_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">_sim_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algts</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">gap</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Calculates the similarity matrix for the set of alignments</span>

<span class="sd">        :param algts: A list of alignments</span>
<span class="sd">        :type algts: ListType</span>
<span class="sd">        :param D: Retention time tolerance parameter for pairwise alignments</span>
<span class="sd">        :type D: FloatType</span>
<span class="sd">        :param gap: Gap parameter for pairwise alignments</span>
<span class="sd">        :type gap: FloatType</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">algts</span><span class="p">)</span>

        <span class="n">total_n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Calculating pairwise alignments for </span><span class="si">%d</span><span class="s2"> alignments (D=</span><span class="si">%.2f</span><span class="s2">, gap=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">gap</span><span class="p">))</span>

        <span class="n">sim_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">ma</span> <span class="o">=</span> <span class="n">Function</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">algts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">algts</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">D</span><span class="p">,</span> <span class="n">gap</span><span class="p">)</span>
                <span class="n">sim_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">similarity</span>
                <span class="n">total_n</span> <span class="o">=</span> <span class="n">total_n</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; -&gt; </span><span class="si">%d</span><span class="s2"> pairs remaining&quot;</span> <span class="o">%</span> <span class="n">total_n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sim_matrix</span></div>

<div class="viewcode-block" id="PairwiseAlignment._dist_matrix"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.PairwiseAlignment._dist_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">_dist_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_matrix</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Converts similarity matrix into a distance matrix</span>

<span class="sd">        :param sim_matrix: The similarity matrix</span>
<span class="sd">        :type sim_matrix: numpy.ndarray</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># change similarity matrix entries (i,j) to max{matrix}-(i,j)</span>
        <span class="n">sim_max</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">sim_matrix</span><span class="p">))</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">sim_max</span> <span class="o">-</span> <span class="n">sim_matrix</span>

        <span class="c1"># set diagonal elements of the similarity matrix to zero</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">)):</span>
            <span class="n">dist_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">dist_matrix</span></div>

<div class="viewcode-block" id="PairwiseAlignment._guide_tree"><a class="viewcode-back" href="../../../../../pyms/Peak/Peak.html#pyms.Peak.List.DPA.Class.PairwiseAlignment._guide_tree">[docs]</a>    <span class="k">def</span> <span class="nf">_guide_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :summary: Build a guide tree from the distance matrix</span>

<span class="sd">        :param dist_matrix: The distance matrix</span>
<span class="sd">        :type dist_matrix: numpy.ndarray</span>
<span class="sd">        :return: Pycluster similarity tree</span>
<span class="sd">        :rtype: Pycluster.cluster.Tree</span>

<span class="sd">        :author: Woon Wai Keen</span>
<span class="sd">        :author: Vladimir Likic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; -&gt; Clustering </span><span class="si">%d</span><span class="s2"> pairwise alignments.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">treecluster</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">distancematrix</span><span class="o">=</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tree</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright PyMassSpec Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>